<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Reporte de Incidentes</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/html2canvas.min.js"></script>
    <script src="js/canvas2image.js"></script>
</head>
</head>

<body>
    <div class="container">
        <div class="main">
            <div class="banner">
                <h1>REPORTE DE INCIDENTES</h1>
            </div>
            <div id="main_form" class="form-container">
                <form autocomplete="off" id="form_incidente">
                    <div class="input-container">
                        <label for="numero_incidente">Numero de Incidente</label>
                        <input type="text" name="numero_incidente" id="numero_incidente">
                    </div>
                    <div class="input-container">
                        <label for="incidente_asociado">Incidentes Asociados</label>
                        <textarea name="incidente_asociado" id="incidente_asociado"></textarea>
                    </div>
                    <div class="input-container">
                        <label for="tipo_incidente">Tipo de Incidente</label>
                        <select id="tipo_incidente">
                            <option selected hidden>-- Seleccione Aqui --</option> 
                            <option value="con_servivio">Con Servicio</option> 
                            <option value="sin_servicio">Sin Servicio</option>
                            <option value="alumbrado_publico">Alumbrado Publico</option>
                          </select>
                    </div>
                    <div class="input-container multi-option">
                        <div class="option-both">
                            <label for="dispositivo_afectado">Dispositivo o Elemento Afectado</label>
                            <select id="dispositivo_afectado">
                                <option selected hidden>-- Seleccione Aqui --</option> 
                                <option value="trafo">Trafo Monofasico</option> 
                                <option value="trafo">Trafo Trifasico</option> 
                                <option value="codigo">Seccionador Fusible</option>
                                <option value="codigo">Seccionador Cuchilla</option>
                                <option value="puente">Puente</option>
                                <option value="poste">Poste</option>
                                <option id="iluminaria" value="iluminaria" disabled>Iluminaria</option>
                                <option value="medidor_dispositivo">Medidor</option>
                                <option value="poste">Red de MV/BV</option>
                                <option value="otro">Otros</option>
                            </select>
                        </div>
                        <div id="otro_dispositivo" class="option-both otro-option">
                            <label for="otro_dispositivo_text">Otros</label>
                            <textarea id="otro_dispositivo_text" name="otro_dispositivo_text"></textarea>
                        </div>
                    </div>
                    <div class="input-container wrap">
                        <div class="option-both">
                            <label id="onchange_dispositivo" for="nombre_dispositivo">Nombre de Dispositivo</label>
                            <input type="text" name="nombre_dispositivo" id="nombre_dispositivo">
                        </div>
                        <div id="fases" class="option-both fw_pt10">
                            <label for="fases_afectadas">Fases Afectadas</label>
                            <select id="fases_afectadas">
                                <option selected hidden>-- Seleccione Aqui --</option> 
                                <option value="1F">1F</option> 
                                <option value="2F">2F</option>
                                <option value="3F">3F</option>
                              </select>
                        </div>
                    </div>
                    <div class="input-container overflow-control">
                        <p>Fecha y Hora de Superacion</p>
                        <div class="date-time-container">
                            <div class="date">
                                <label for="fecha">Fecha</label>
                                <input type="date" name="fecha" id="fecha">
                            </div>
                            <div class="time">
                                <label for="hora">Hora</label>
                                <input type="time" name="hora" id="hora">
                            </div>
                        </div>
                    </div>
                    <div class="input-container multi-option">
                        <div class="option-both">
                            <label for="causa_incidente">Causa del Incidente</label>
                            <select id="causa_incidente">
                                <option selected hidden>-- Seleccione Aqui --</option> 
                                <option value="descarga_atm">Descarga ATM</option> 
                                <option value="lluvia">Lluvia</option>
                                <option value="viento">Viento</option>
                                <option value="corrosion">Corrosion</option>
                                <option value="incendio">Incendio</option>
                                <option value="deslizamiento_terreno">Deslizamiento de Terreno</option>
                                <option value="inundacion">Inundacion</option>
                                <option value="arboles">Arboles</option>
                                <option value="aves">Aves</option>
                                <option value="animales">Otros Animales</option>
                                <option value="daño_intencional">Daño Intencional</option>
                                <option value="daño_accidental">Daño accidental de particulares</option>
                                <option value="choque">Choque</option>
                                <option value="servicio_normal">Servicio Normal</option>
                                <option value="daño_interno">Daño Interno</option>
                                <option value="construccion">Diseño, instalacion o construccion</option>
                                <option value="proteccion">Proteccion</option>
                                <option value="equipamiento">Falla de equipamiento</option>
                                <option value="otro">Otros</option>
                            </select>
                        </div>
                        <div id="otra_causa" class="option-both otro-option">
                            <label for="otro_causa_text">Otros</label>
                            <textarea name="otra_causa_text" id="otra_causa_text"></textarea>
                        </div>
                    </div>
                    <div class="input-container multi-option">
                        <div class="option-both">
                            <label for="componente_falla">Componente con Falla</label>
                            <select id="componente_falla">
                                <option selected hidden>-- Seleccione Aqui --</option> 
                                <option value="disyuntor">Disyuntor</option> 
                                <option value="reconectador">Reconectador</option>
                                <option value="transformador">Transformador de Distribucion</option>
                                <option value="camara">Camara de Transformacion</option>
                                <option value="seccionador_componente">Seccionador</option>
                                <option value="seccionalizador">Seccionalizador</option>
                                <option value="tc">TC</option>
                                <option value="tp">TP</option>
                                <option value="pararrayo_componente">Pararrayo</option>
                                <option value="conductor_aereo">Conductor Aereo</option>
                                <option value="conductor_subterraneo">Conductor Subterraneo</option>
                                <option value="poste_distribucion">Poste de Distribucion</option>
                                <option value="fusible_componente">Fusible</option>
                                <option value="base_portafusible">Base Portafusible</option>
                                <option value="aislador">Aislador</option>
                                <option value="medidor_bt_mt">Medidor de BT/MT</option>
                                <option value="acometida_componente">Acometida</option>
                                <option value="conector">Conector</option>
                                <option value="otro">Otros</option>
                          </select>
                        </div>
                        <div id="otro_componente" class="option-both otro-option">
                            <label for="otro_componente_text">Otros</label>
                            <textarea name="otro_componente_text" id="otro_componente_text"></textarea>
                        </div>
                    </div>
                    <div class="input-container multi-option">
                        <div class="option-both">
                            <label for="detalle_problema">Detalle del Problema</label>
                            <select id="detalle_problema">
                                <option selected hidden>-- Seleccione Aqui --</option> 
                                <option value="acometida_arrancada">Acometida Arrancada</option> 
                                <option value="bajante">Bajante del transformador</option>
                                <option value="base_portafusible">Base portafusible</option>
                                <option value="bornera">Bornera Floja</option>
                                <option value="breaker">Breaker desconectado/averiado</option>
                                <option value="bushing">Bushing</option>
                                <option value="conector">Conector en mal estado</option>
                                <option value="conexion_floja">Conexion Floja</option>
                                <option value="cortocircuito">Cortocircuito en Acometida</option>
                                <option value="cortocircuito_red">Cortocircuito en red de BV/MV</option>
                                <option value="foco">Foco</option>
                                <option value="fotocelula">Fotocelula</option>
                                <option value="fusible_quemado">Fusible Quemado</option>
                                <option value="energia_hurto">Hurto de Energia</option>
                                <option value="linea_floja">Lineas Flojas</option>
                                <option value="lineas_rotas">Lineas Rotas</option>
                                <option value="medidor_averiado">Medidor Averiado</option>
                                <option value="medidor_suspendido">Medidor Suspendido por Mora</option>
                                <option value="pararrayo">Pararrayo en mal estado</option>
                                <option value="poste">Poste caido/en mal estado</option>
                                <option value="seccionador">Seccionador en mal estado</option>
                                <option value="tensores">Tensor roto/flojo</option>
                                <option value="trafo_daño">Trafo con daño</option>
                                <option value="otro">Otros</option>
                            </select>
                        </div>
                        <div id="otro_detalle" class="option-both otro-option">
                            <label for="otro_detalle">Otros</label>
                            <textarea name="otro_detalle" id="otro_detalle"></textarea>
                        </div>
                    </div>
                    <div class="input-container">
                        <label for="comentario_informe">Comentario</label>
                        <textarea name="comentario_informe" id="comentario_informe"></textarea>
                    </div>
                    <input type="button" id="enviar" value="Generar Informe">
                </form>
            </div>
        </div>
        <div id="informe_container" class="informe">
            <form class="informe-options">
                <input type="button" id="nuevo_informe" value="Crear Nuevo Informe">
                <input type="button" id="modificar_informe" value="Modificar Informe">
                <a id="wpp" href="whatsapp://send?text='+encodeURIComponent(imageURL)">Enviar Informe</a>
                <input type="button" id="download" value="Descargar Informe">
                <input type="button" id="confirmar" value="Confirmar Informe">
            </form>
            <div id="informe_png">
                <table class="tabla-informe">
                    <tr>
                        <th>No. Incidente</th>
                        <td id="no_incidente_table"></td>
                    </tr>
                    <tr>
                        <th>Incidentes Asociados</th>
                        <td id="incidentes_asociados_table"></td>
                    </tr>
                    <tr>
                        <th>Tipo de Incidente</th>
                        <td id="tipo_incidente_table"></td>
                    </tr>
                    <tr>
                        <th>Dispositivo o Elemento Afectado</th>
                        <td id="dispositivo_afectado_table"></td>
                    </tr>
                    <tr>
                        <th id="dispositivo_table">Nombre de Dispositivo</th>
                        <td id="no_dispositivo_table"></td>
                    </tr>
                    <tr id="fases_afectadas_tr">
                        <th>Fases Afectadas</th>
                        <td id="fases_afectadas_table"></td>
                    </tr>
                    <tr>
                        <th>Fecha y Hora de Superacion</th>
                        <td id="fecha_hora_table"></td>
                    </tr>
                    <tr>
                        <th>Causa del Incidente</th>
                        <td id="causa_table"></td>
                    </tr>
                    <tr>
                        <th>Componente con Falla</th>
                        <td id="componente_table"></td>
                    </tr>
                    <tr>
                        <th>Detalle del Problema</th>
                        <td id="detalle_table"></td>
                    </tr>
                    <tr>
                        <th>Comentario</th>
                        <td id="comentario_table"></td>
                    </tr>
                </table>
            </div>
            <div id="preview"></div>
        </div>
    </div>
    <script src="js/script.js"></script>
    <script>
        const $boton = document.querySelector("#confirmar"), // El botón que desencadena
            $objetivo = document.querySelector("#informe_png"), // A qué le tomamos la foto
            $contenedorCanvas = document.querySelector("#preview"), // En dónde ponemos el elemento canvas
            $wpp_message = document.querySelector("#wpp");

        // Agregar el listener al botón
        $boton.addEventListener("click", () => {
            html2canvas($objetivo) // Llamar a html2canvas y pasarle el elemento
                .then(canvas => {
                    // Cuando se resuelva la promesa traerá el canvas
                    $contenedorCanvas.appendChild(canvas); // Lo agregamos como hijo del div
                    canvas.id = "canvas";
                });

        });

        $boton.addEventListener("click", function() {
            document.getElementById("nuevo_informe").style.display = "block";
            document.getElementById("modificar_informe").style.display = "none";
            document.getElementById("confirmar").style.display = "none";
            document.getElementById("download").style.display = "block";
            document.getElementById("wpp").style.display = "block";
        });

        const $canvas = document.querySelector("#canvas"),
            $boton_descargar = document.querySelector("#download");

        $boton_descargar.addEventListener("click", () => {
            // Crear un elemento <a>
            let enlace = document.createElement('a');
            // El título
            enlace.download = "informe.png";
            // Convertir la imagen a Base64 y ponerlo en el enlace
            enlace.href = canvas.toDataURL();
            $wpp_message.href = 'whatsapp://send?text=' + encodeURIComponent(canvas.toDataURL());
            // Hacer click en él
            enlace.click();
        });
    </script>
</body>

</html>